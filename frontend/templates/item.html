{% extends 'base.html' %}

{% block body %}

<!-- ========================= SECTION PAGETOP ========================= -->
<section class="section-pagetop bg-primary border-bottom">
	<div class="container">
		<h2 class="title-page text-white">Item "{{ details.name }}"</h2>
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb text-white">
				<li class="breadcrumb-item"><a href="index.html" class="text-white">Página inicial</a></li>
				<li class="breadcrumb-item"><a href="buy.html" class="text-white">Lista de items</a></li>
				<li class="breadcrumb-item active" aria-current="page">Detalhes do item</li>
			</ol>
		</nav>
	</div>
</section>
<!-- ========================= SECTION PAGETOP END// ========================= -->


<!-- ========================= SECTION CONTENT ========================= -->
<section class="section-content padding-y bg">
	<div class="container">

		<!-- ============================ PRODUCT DETAIL ================================= -->
		<div id="product-detail">
			<div class="card sc-product-item">
				<div class="row no-gutters align-items-center">
					<aside class="col-md-6">
						<article class="gallery-wrap">
							<div class="img-big-wrap">
								<a href="#"><img src="{{details.image}}" class="img-fluid h-auto" alt=""
										data-name="product_image"></a>
							</div>
							<div class="thumbs-wrap">
								<a href="#" class="item-thumb"><img src="{{details.image}}" alt=""></a>
							</div>
						</article>
					</aside>
					<main class="col-md-6 border-left">
						<article class="content-body">
							<h2 class="title" data-name="product_name">{{details.name}}</h2>

							{% if details.availability %}
							<ul class="list-check pt-1">
								<li class="text-success">Disponível para encomenda</li>
							</ul>
							{% else %}
							<ul class="list-dots pt-1">
								<li class="text-muted">Indisponível de momento</li>
							</ul>
							{% endif %}

							<div class="rating-wrap my-3">
								<ul class="rating-stars">
									<li style="width:{{ details.rating * 100 / 5 }}%" class="stars-active">
										<img src="{{ url_for('static', path='images/icons/stars-active.svg') }}" alt="">
									</li>
									<li>
										<img src="{{ url_for('static', path='images/icons/stars-disable.svg') }}"
											alt="">
									</li>
								</ul>
								<small class="label-rating">{{ details.rating }}</small>
								<i class="dot"></i>
								<small class="label-rating text-muted"><i class="fas fa-comment-dots"></i> {{
									details.reviews }}
									avaliaç{{ 'ão' if details.reviews == 1 else 'ões' }}
								</small>
								<i class="dot"></i>
								<small class="label-rating text-primary"><i class="fas fa-shopping-basket"></i>
									{{ details.orders }} encomenda{{ '' if details.orders == 1 else 's' }}</small>
							</div>

							<div class="mb-3">
								<var class="price h4">{{ details.price.replace('.',',') }}€</var>
								{% if details.old_price %}
								<del class="price-old">{{ details.old_price.replace('.',',') }}€</del>
								{% endif %}
								<small class="text-muted"> /unidade</small>
							</div>

							<p class="text-justify">{{ details.description }}</p>

							<dl class="row">
								<dt class="col">Produtor:</dt>
								<dd class="col-sm-9" data-name="product_desc"><a
										href="buy.html?producer={{ details.user }}"
										title="Ver mais produtos deste produtor">{{ details.user }}</a></dd>
							</dl>
							<dl class="row">
								<dt class="col">Categoria:</dt>
								<dd class="col-sm-9">{{ details.category }}</dd>
							</dl>

							<hr>
							<form id="product" action="checkout.html">
								<div class="row justify-content-between align-items-end">
									<div class="col-md flex-grow-0">
										<label>Quantidade:</label>
										<div class="input-group input-spinner mb-3 mb-lg-1">
											<div class="input-group-prepend">
												<button class="btn btn-light" type="button"
													id="button-minus">&#8722;</button>
											</div>
											<div class="input-group-append input-group-prepend">
												<input type="number" id="product_quantity" name="product_quantity"
													class="btn btn-light font-weight-bolder no-controls" value="1"
													min="1" max="{{details.quantity}}"
													title="Quantidade disponível para compra: {{details.quantity}}"
													autocomplete="off" required>
											</div>
											<div class="input-group-append">
												<button class="btn btn-light" type="button" id="button-plus">+</button>
											</div>
										</div>
									</div>
									<div class="col-12 col-lg">
										<button type="submit" class="btn btn-primary mb-1 sc-add-to-cart">Comprar
											agora</button>
										<button type="button" id="add-cart"
											class="btn btn-outline-primary ml-xl-2 mb-1 sc-add-to-cart">Adicionar ao
											carrinho <i class="fas fa-shopping-cart"></i></button>
										<button type="button"
											class="btn btn-outline-danger ml-xl-2 mb-1 sc-remove-from-cart"
											style="display: none;">Remover do carrinho <i
												class="fas fa-shopping-cart"></i></button>
										<button type="button" class="btn btn-primary btn-block ml-xl-2 mb-1 unavailable"
											style="display: none;" disabled>Indisponível para compra</button>
									</div>
								</div>
							</form>
							<input name="product_price" value="{{ details.price }}" type="hidden">
							<input name="product_id" value="{{ details.id }}" type="hidden">
							<input name="product_quantity_max" value="{{ details.quantity }}" type="hidden">
						</article>
					</main>
				</div>
			</div>
		</div>
		<!-- ============================ PRODUCT DETAIL END// ================================= -->

		<!-- ============================ PRODUCT FEEDBACK & RELATED PRODUCTS ================================= -->
		<div class="row mt-4 justify-content-between">
			<div class="col-md-8 pr-5" id="product-feedback"></div>

			<div class="col-md-4 pt-5 mt-3" id="section-related" style="display: none;">
				<div class="card mt-5">
					<div class="card-body" id="product-related">
						<h5 class="card-title mb-4">Produtos sugeridos</h5>
					</div>
				</div>
			</div>
		</div>
		<!-- ============================ PRODUCT FEEDBACK & RELATED PRODUCTS END// ================================= -->

	</div>
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

{% endblock %}

{% block scripts %}
<script>
	$(document).ready(function () {

		// Related products counter
		var i = 0;
		var quantity_left = {{ details.quantity }};

	/*


			var availability = "available";
			var quantity_left = {{details.quantity}};
			if (quantity_left < 1) {
				availability = "unavailable";
			}

			var ratings = 0;								// Sum of all ratings
			var reviews = 0; 								// Total number of reviews
			for (var number in products[key].feedback) {
				if (products[key].feedback.hasOwnProperty(number)) {
					ratings += parseInt(products[key].feedback[number].rating); // Append each individual rating
					reviews++;
				}
			}
			var rating = 0; 								// Average rating
			if (reviews != 0) {
				rating = (ratings / reviews).toFixed(1);
			}
			var stars = (rating * 100 / 5).toFixed(2);			// Width of rating stars icons of in percentage

			$("#product-detail").append(`
					
				`);

			if (quantity_left < 1) {
				$('.sc-add-to-cart').hide();
				$('#product_quantity, #button-plus, #button-minus').prop('disabled', true);
				$('.unavailable').show();
			}

			$("#product-feedback").append(`
					<header class="section-heading">
						<h3>Feedback</h3>  
						<div class="rating-wrap">
							<ul class="rating-stars stars-lg">
								<li style="width:${stars}%" class="stars-active">
									<img src="images/icons/stars-active.svg" alt="">
								</li>
								<li>
									<img src="images/icons/starts-disable.svg" alt="">
								</li>
							</ul>
							<strong class="label-rating text-lg">${rating}<span class="text-muted ml-1"> | <i class="fas fa-comment-dots ml-1 mr-1"></i> ${reviews} avaliaç${reviews != 1 ? "ões" : "ão"}</span></strong>
						</div>
					</header>
				`);

			
					$("#product-feedback").append(`
							<article class="box mb-3">
								<div class="icontext w-100">
									<img src="${products[key].feedback[count].avatar}" class="img-xs icon rounded-circle" alt="">
									<div class="text">
										<span class="date text-muted float-right">${products[key].feedback[count].date}</span>  
										<h6 class="mb-1">${products[key].feedback[count].name}</h6>
										<ul class="rating-stars">
											<li style="width:${(products[key].feedback[count].rating * 100 / 5).toFixed(0)}%" class="stars-active">
												<img src="images/icons/stars-active.svg" alt="">
											</li>
											<li>
												<img src="images/icons/starts-disable.svg" alt="">
											</li>
										</ul>
										<span class="label-rating text-warning">${products[key].feedback[count].rating}</span>
									</div>
								</div>
								<p class="mt-3">${products[key].feedback[count].comment}</p>	
							</article>
						`);
				
			

		
			// Show 3 random suggested products from the products list
			if (i < 3) {
				$("#product-related").append(`
						<article class="itemside mb-3">
							<a href="product.html?id=${products[key].id}" class="aside">
								<img src="${products[key].image}" width="96" height="96" class="img-sm img-thumbnail">
								<div class="info">
									<a href="product.html?id=${products[key].id}" class="title mb-1">${products[key].name}</a>
									<p class="text-muted small my-1">Produtor: ${products[key].producer}</p>
									<strong class="price">${products[key].price}€<small class="text-muted"> /kg</small></strong>
								</div>
							</a>
						</article>
					`);
				i++;
			}

			*/

		$('#smartcart').smartCart();

		$('#add-cart.sc-add-to-cart').click(function () {
			$(this).hide().next('.sc-remove-from-cart').show();
		});

		$('.sc-remove-from-cart').click(function () {
			$('.sc-added-item').removeData("product-unique-key");
			unique_key = $(this).parent().closest('.sc-added-item').data('product-unique-key');
			$('#smartcart').smartCart('remove', unique_key);
			$(this).hide().prev('#add-cart.sc-add-to-cart').show();
		});

		$("#product #button-minus").click(function () {
			let value = $('#product input[name=product_quantity]').val();

			if (value > 1) {
				$('#product input[name=product_quantity]').val(--value);
			} else {
				$('#product input[name=product_quantity]').val(1);
			}

			if (value == 1) {
				$(this).prop('disabled', true);
			} else {
				$(this).prop('disabled', false);
			}
			$(this).parent().parent().find('#button-plus').prop('disabled', false);
		});
		$("#product #button-plus").click(function () {
			let value = $('#product input[name=product_quantity]').val();

			if (value < parseInt(quantity_left)) {
				$('#product input[name=product_quantity]').val(++value);
			} else {
				$('#product input[name=product_quantity]').val(quantity_left);
			}

			if (value == quantity_left) {
				$(this).prop('disabled', true);
			} else {
				$(this).prop('disabled', false);
			}
			$(this).parent().parent().find('#button-minus').prop('disabled', false);
		});

		$("#product input[name=product_quantity").on("input", function () {
			let current_value = $(this).val();
			let max_value = $(this).attr("max");

			if (isNaN(current_value) || current_value <= 1) {
				$(this).val(1);
				$(this).parent().parent().find('#button-minus').prop('disabled', true);
				$(this).parent().parent().find('#button-plus').prop('disabled', false);
			} else if (current_value >= parseInt(max_value)) {
				$(this).val(max_value);
				$(this).parent().parent().find('#button-plus').prop('disabled', true);
				$(this).parent().parent().find('#button-minus').prop('disabled', false);
			} else {
				$(this).val(current_value);
				$(this).parent().parent().find('#button-minus').prop('disabled', false);
				$(this).parent().parent().find('#button-plus').prop('disabled', false);
			}
		});
	});
</script>
{% endblock %}